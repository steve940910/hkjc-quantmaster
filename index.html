<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKJC Quant Master</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: "Microsoft JhengHei", sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
        
        .rank-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; min-width: 60px; text-align: center; }
        .rank-Banker { background-color: #ef4444; color: white; }
        .rank-Core { background-color: #f59e0b; color: black; }
        .rank-Value { background-color: #1d4ed8; color: #bfdbfe; border: 1px solid #3b82f6; } 
        .rank-Risk { background-color: #7c3aed; color: #ddd6fe; }
        .rank-Average { background-color: #047857; color: #6ee7b7; border: 1px solid #10b981; }
        .rank-Low { background-color: #334155; color: #94a3b8; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10b981; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .race-btn.active { transform: scale(1.05); }
    </style>
</head>
<body class="p-4 lg:p-8">

<div class="max-w-6xl mx-auto space-y-6">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-slate-800 pb-4">
        <div>
            <h1 class="text-3xl font-bold text-emerald-400 flex items-center gap-2">
                ğŸ‡ è³½é¦¬é‡åŒ–å¤§å¸«
            </h1>
            <p class="text-slate-400 text-sm">Public Viewer v1.2</p>
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-3 bg-slate-800 p-2 rounded-lg border border-slate-700 shadow-lg">
                <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">ğŸ“… æ—¥æœŸï¼š</span>
                <select id="date-select" onchange="onDateChange()" class="bg-slate-900 text-white text-sm border border-slate-600 rounded px-2 py-1 outline-none focus:border-emerald-500 transition-colors font-mono cursor-pointer">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
                <button onclick="fetchHistoryList()" class="bg-slate-700 hover:bg-slate-600 text-emerald-400 p-1 rounded transition" title="é‡æ–°æ•´ç†åˆ—è¡¨">
                    ğŸ”„
                </button>
            </div>
        </div>
    </header>

    <div id="race-buttons-container" class="flex flex-wrap gap-2 animate-fade-in">
        <div class="text-slate-500 text-sm italic py-2">ç­‰å¾…é¸æ“‡æ—¥æœŸ...</div>
    </div>

    <div id="dashboard" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="card bg-slate-800 py-3"><span class="text-slate-500 text-xs uppercase">å ´æ¬¡</span><div id="race-no" class="text-2xl font-bold text-white">--</div><div id="race-venue" class="text-xs text-emerald-400">--</div></div>
                <div class="card bg-slate-800 py-3"><span class="text-slate-500 text-xs uppercase">ç­æ¬¡/è·‘é“</span><div id="race-class" class="text-lg font-bold text-white mt-1">--</div><div id="race-course" class="text-xs text-blue-400">--</div></div>
                <div class="card bg-slate-800 py-3"><span class="text-slate-500 text-xs uppercase">è·¯ç¨‹</span><div id="race-dist" class="text-2xl font-bold text-white">--</div></div>
                <div class="card bg-slate-800 py-3 border border-yellow-900/50"><span class="text-slate-500 text-xs uppercase">æ­¥é€Ÿ PPI</span><div id="race-ppi" class="text-xl font-bold text-yellow-400 mt-1">--</div></div>
            </div>

            <div class="card border border-purple-500/30 bg-purple-900/10">
                <h3 class="text-lg font-bold mb-2 text-purple-300 flex items-center gap-2">ğŸ§  æ™ºèƒ½ç­–ç•¥å»ºè­°</h3>
                <div id="strategy-content" class="text-sm text-slate-300 space-y-2"></div>
            </div>

            <div id="betting-slip-card" class="hidden card border border-blue-500/30 bg-blue-900/10">
                <h3 class="text-lg font-bold mb-3 text-blue-300 flex items-center gap-2">ğŸ¯ æŠ•æ³¨çœ‹æ¿ (Betting Slip)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-400 mb-2 uppercase tracking-wider">ğŸ›¡ï¸ ç©©å¥å‡ºæ“Š (Standard)</div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="rank-badge-label bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">è†½</span>
                            <div id="slip-banker" class="font-bold text-lg text-white">--</div>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="bg-slate-600 text-white text-xs font-bold px-2 py-1 rounded mt-1">æ‹–</span>
                            <div id="slip-legs" class="text-sm text-slate-300 leading-6">--</div>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-400 mb-2 uppercase tracking-wider">ğŸ’£ åˆ€ä»”é‹¸æ¨¹ (Value Hunt)</div>
                        <div id="slip-wildcard" class="flex flex-col gap-2">
                            </div>
                        <div style="display:none"><span id="slip-wildcard-reason"></span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-bold mb-4 text-slate-200 flex justify-between"><span>ğŸ“ˆ DMR èƒ½åŠ›åˆ†ä½ˆ</span><span id="race-date-display" class="text-sm font-normal text-slate-500">--</span></h3>
                <div class="relative h-[400px] w-full"><canvas id="dmrChart"></canvas></div>
            </div>
        </div>

        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="card flex-grow flex flex-col" style="max-height: 600px;">
                <h3 class="text-lg font-bold mb-4 text-slate-200">ğŸ“‹ åƒ¹å€¼åˆ†æè¡¨</h3>
                <div class="overflow-y-auto flex-grow pr-1">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0">
                            <tr><th class="px-2 py-2">No.</th><th class="px-2 py-2">é¦¬å (CN)</th><th class="px-2 py-2 text-right">DMR</th><th class="px-2 py-2 text-center">è©•ç´š</th></tr>
                        </thead>
                        <tbody id="horse-table-body" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="result-display-card" class="hidden card border border-yellow-600/30 bg-yellow-900/10 shadow-lg">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 flex items-center gap-2">ğŸ† è³½äº‹çµæœ</h3>
                <div class="space-y-2" id="result-list"></div>
            </div>
        </div>
    </div>

    <div class="mt-12 border-t border-slate-800 pt-8 text-slate-500 text-sm">
        <h4 class="text-emerald-500 font-bold mb-4 text-lg">ğŸ“Š é—œæ–¼ Quant Master æ¨¡å‹</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h5 class="font-bold text-slate-300 mb-2">DMR (å‹•æ…‹å¤§å¸«è©•åˆ†)</h5>
                <p class="leading-relaxed opacity-80">åŸºæ–¼ SpeedPRO èƒ½é‡æŒ‡æ•¸è¨ˆç®—çš„ã€ŒçœŸå¯¦èƒ½åŠ›å€¼ã€ã€‚çµåˆäº†é¦¬åŒ¹çš„ã€ŒåŸºç¤èƒ½åŠ›ã€èˆ‡ã€Œè¿‘æœŸç‹€æ…‹ã€ï¼Œä¸¦å°è² ç£…èˆ‡å¥åº·ç‹€æ³é€²è¡ŒåŠ æ¬Šä¿®æ­£ã€‚</p>
            </div>
            <div>
                <h5 class="font-bold text-slate-300 mb-2">TIR (å—é˜»è£œå„Ÿ)</h5>
                <p class="leading-relaxed opacity-80">Trouble-In-Runningã€‚ç³»çµ±æœƒæƒæè³½å¾Œå ±å‘Šï¼Œè‹¥é¦¬åŒ¹ä¸Šä»—æ›¾é­é‡ã€Œåš´é‡å—é˜»ã€æˆ–ã€Œå…¨ç¨‹èµ°å¤–ç–Šã€ï¼Œå°‡çµ¦äºˆé¡å¤–åŠ åˆ†ã€‚</p>
            </div>
            <div>
                <h5 class="font-bold text-slate-300 mb-2">PPI (æ­¥é€Ÿå£“åŠ›æŒ‡æ•¸)</h5>
                <p class="leading-relaxed opacity-80">åˆ†æå ´æ¬¡ä¸­é ˜æ”¾é¦¬çš„æ•¸é‡ã€‚PPI > 5 ç‚ºå¿«æ­¥é€Ÿ (åˆ©å¾Œä¸Š)ï¼›PPI < 2 ç‚ºæ…¢æ­¥é€Ÿ (åˆ©å–®é¨é ˜æ”¾)ã€‚</p>
            </div>
        </div>
        <div class="mt-8 text-center text-xs opacity-40 font-mono">
            Â© 2025 HKJC Quant Master. Powered by Gemini AI. For reference only.
        </div>
    </div>

</div>

<script>
    // ==========================================
    // ğŸ”‘ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºä½ çš„ Apps Script ç¶²å€
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwmLL4nDIwmReQ_WGjeekHKlZDBFxTRMfudynfZgukXJzwh50xiqbUHZxzwE5nHAFG2ng/exec"; 
    // ==========================================
    
    let myChart = null;
    let currentData = null;
    let fullHistoryList = []; 

    window.onload = function() { fetchHistoryList(); };

    function renderDashboard(data) {
        document.getElementById('dashboard').classList.remove('hidden');
        
        document.getElementById('race-date-display').innerText = data.race_info.date;
        document.getElementById('race-venue').innerText = data.race_info.venue;
        document.getElementById('race-no').innerText = "R" + data.race_info.race_no;
        document.getElementById('race-class').innerText = data.race_info.class || "-";
        document.getElementById('race-course').innerText = data.race_info.course || "-";
        document.getElementById('race-dist').innerText = data.race_info.distance + "m";
        document.getElementById('race-ppi').innerText = data.race_info.ppi_score;

        const tbody = document.getElementById('horse-table-body');
        tbody.innerHTML = '';
        const sortedHorses = [...data.horses].sort((a, b) => b.dmr_score - a.dmr_score);
        
        const resultCard = document.getElementById('result-display-card');
        const resultList = document.getElementById('result-list');
        let hasResults = false;
        let results = []; 

        generateStrategy(sortedHorses);
        generateBettingSlip(sortedHorses); // ä½¿ç”¨ Strict Value é‚è¼¯

        sortedHorses.forEach(h => {
            let badgeClass = 'rank-Low';
            let badgeText = h.rank_prediction;

            if(h.rank_prediction.includes('Banker')) { badgeClass = 'rank-Banker'; badgeText = 'BANKER'; }
            else if(h.rank_prediction.includes('Core')) { badgeClass = 'rank-Core'; badgeText = 'CORE'; }
            else if(h.rank_prediction.includes('Value')) { badgeClass = 'rank-Value'; badgeText = 'VALUE**'; }
            else if(h.rank_prediction.includes('Risk')) { badgeClass = 'rank-Risk'; badgeText = 'RISK'; }
            else if(h.rank_prediction.includes('Average')) { badgeClass = 'rank-Average'; badgeText = 'AVG'; }
            else { badgeText = 'LOW'; }

            if (h.actual_placing && h.actual_placing <= 4) {
                hasResults = true;
                results.push(h);
            }

            const displayName = h.name_ch ? h.name_ch : h.name;
            
            const row = `
                <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800 last:border-0">
                    <td class="px-2 py-3 font-bold text-slate-400 text-center font-mono">${h.number}</td>
                    <td class="px-2 py-3">
                        <div class="font-medium text-base text-slate-200">${displayName}</div>
                        <div class="text-xs text-slate-600">${h.name}</div>
                        ${h.tir_bonus !== '+0.0' && h.tir_bonus !== '0' && h.tir_bonus !== "'+0.0" ? `<div class="text-xs text-blue-400 mt-1">TIR: ${h.tir_bonus.replace("'","")}</div>` : ''}
                    </td>
                    <td class="px-2 py-3 text-right font-mono text-emerald-400 font-bold text-lg tracking-tight">${h.dmr_score}</td>
                    <td class="px-2 py-3 text-center"><span class="rank-badge ${badgeClass}">${badgeText}</span></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        if (hasResults) {
            resultCard.classList.remove('hidden');
            results.sort((a, b) => a.actual_placing - b.actual_placing);
            let html = '';
            const medalMap = { 1: 'ğŸ¥‡ å† è»', 2: 'ğŸ¥ˆ äºè»', 3: 'ğŸ¥‰ å­£è»', 4: 'æ®¿è»' };
            const textColors = ['text-yellow-400', 'text-slate-300', 'text-orange-400', 'text-slate-400'];
            const bgColors = ['bg-yellow-400/10', 'bg-slate-400/10', 'bg-orange-400/10', 'bg-slate-400/5'];

            results.forEach((h, index) => {
                const p = h.actual_placing;
                const medalText = medalMap[p] || `ç¬¬${p}å`;
                const textColor = index < 4 ? textColors[index] : 'text-slate-500';
                const bgColor = index < 4 ? bgColors[index] : '';

                html += `
                    <div class="flex justify-between items-center border-b border-yellow-900/30 pb-2 last:border-0 ${bgColor} p-2 rounded mb-1">
                        <div class="${textColor} font-bold text-sm w-16 flex items-center gap-1">${medalText}</div>
                        <div class="flex-1 flex items-center gap-3">
                            <span class="bg-slate-800 text-white text-xs px-1.5 py-0.5 rounded font-mono border border-slate-700">${h.number}</span>
                            <span class="text-white font-medium">${h.name_ch || h.name}</span>
                        </div>
                        <div class="text-xs text-slate-500 font-mono">DMR ${h.dmr_score}</div>
                    </div>
                `;
            });
            resultList.innerHTML = html;
        } else {
            resultCard.classList.add('hidden');
        }

        const ctx = document.getElementById('dmrChart').getContext('2d');
        if(myChart) myChart.destroy();
        
        const labels = sortedHorses.map(h => h.number + '.' + (h.name_ch || h.name));
        const dmrData = sortedHorses.map(h => h.dmr_score);
        const colors = sortedHorses.map(h => {
            if(h.rank_prediction.includes('Banker')) return '#ef4444';
            if(h.rank_prediction.includes('Core')) return '#f59e0b';
            if(h.rank_prediction.includes('Value')) return '#3b82f6';
            if(h.rank_prediction.includes('Average')) return '#047857';
            if(h.rank_prediction.includes('Risk')) return '#8b5cf6';
            if(h.rank_prediction.includes('Low')) return '#a16207';
            return '#10b981';
        });

        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'DMR', data: dmrData, backgroundColor: colors, borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 60, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false } } }
        });
    }

    function generateStrategy(sortedHorses) {
        const box = document.getElementById('strategy-content');
        if(sortedHorses.length < 3) { box.innerHTML = "æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•åˆ†æã€‚"; return; }
        const h1 = sortedHorses[0]; const h2 = sortedHorses[1]; const h3 = sortedHorses[2]; const h4 = sortedHorses[3];
        const gap1_2 = h1.dmr_score - h2.dmr_score;
        const gap2_3 = h2.dmr_score - h3.dmr_score;
        const gap_top4 = h1.dmr_score - h4.dmr_score;
        const valueHorse = sortedHorses.slice(0, 3).find(h => h.rank_prediction.includes('Value'));
        let strategyHTML = "";
        if (valueHorse) { strategyHTML += `<div class="text-blue-400 font-bold mb-1">ğŸ’ å¯¶è—ç™¼ç¾ (Value Opportunity)</div><p>å†·é–€é¦¬ <b>[${valueHorse.number}] ${valueHorse.name_ch || valueHorse.name}</b> è©•åˆ†é€²å…¥å‰ä¸‰ï¼Œå»ºè­°å°æ³¨ <span class="text-white bg-blue-600 px-1 rounded text-xs">WP</span> æˆ–ä½œç‚ºé…è…³ã€‚</p>`; }
        if (gap1_2 >= 4.0) { strategyHTML += `<div class="text-red-400 font-bold mt-2 mb-1">ğŸ”¥ å–®è†½æ ¼å±€ (Dominant Banker)</div><p>é¦–é¸ <b>[${h1.number}]</b> åˆ†æ•¸å¤§å¹…æ‹‹é›¢ï¼Œå»ºè­°ä»¥å…¶ç‚º <span class="text-white bg-red-600 px-1 rounded text-xs">è†½</span>ï¼Œæ‹–å°„ 2-4 åã€‚</p>`; }
        else if (gap1_2 < 2.0 && gap2_3 >= 3.0) { strategyHTML += `<div class="text-yellow-400 font-bold mt-2 mb-1">âš¡ é›™é¾å‡ºæµ· (Dual Core)</div><p>é¦–å…©å <b>[${h1.number}]</b> èˆ‡ <b>[${h2.number}]</b> å¯¦åŠ›æ¥è¿‘ä¸”æ‹‹é›¢å…¶ä»–é¦¬ï¼Œå»ºè­° <span class="text-black bg-yellow-400 px-1 rounded text-xs">Q / QP</span> äº’ä¸²ã€‚</p>`; }
        else if (gap_top4 < 5.0) { strategyHTML += `<div class="text-purple-400 font-bold mt-2 mb-1">ğŸŒªï¸ æ··æˆ°å±€é¢ (Chaos)</div><p>å‰å››ååˆ†æ•¸å’¬å¾—éå¸¸ç·Šï¼Œæ²’æœ‰çµ•å°å„ªå‹¢ã€‚å»ºè­° <span class="text-white bg-purple-600 px-1 rounded text-xs">è¤‡å¼äº’ä¸²</span> æˆ–åªè²·ä½ç½®Qã€‚</p>`; }
        else { strategyHTML += `<div class="text-emerald-400 font-bold mt-2 mb-1">âš–ï¸ æ¨™æº–è³½äº‹ (Standard)</div><p>å¯¦åŠ›åˆ†ä½ˆæ­£å¸¸ã€‚å»ºè­°ä¾ç…§ DMR é †åºï¼š<b>${h1.number} > ${h2.number} > ${h3.number}</b> é€²è¡Œé¸é¦¬ã€‚</p>`; }
        box.innerHTML = strategyHTML;
    }

    function generateBettingSlip(sortedHorses) {
        const card = document.getElementById('betting-slip-card');
        if (sortedHorses.length < 4) { card.classList.add('hidden'); return; }
        card.classList.remove('hidden');

        // Standard
        const h1 = sortedHorses[0];
        const h2 = sortedHorses[1];
        const gap1_2 = h1.dmr_score - h2.dmr_score;

        let bankerHTML = "";
        let legsHTML = "";

        if (gap1_2 >= 3.0) {
            bankerHTML = `<span class="text-xl font-bold text-red-400">${h1.number}</span> <span class="text-sm ml-1 text-slate-300">${h1.name_ch || h1.name}</span>`;
            legsHTML = sortedHorses.slice(1, 4).map(h => `<span class="bg-slate-700 px-2 py-0.5 rounded mx-1 border border-slate-600 text-slate-300 font-mono">${h.number}</span>`).join("");
            const badge = document.querySelector('#betting-slip-card .rank-badge-label') || document.querySelector('#betting-slip-card .bg-yellow-600');
            if(badge) { badge.className = "rank-badge-label bg-red-600 text-white text-xs font-bold px-2 py-1 rounded"; badge.innerText = "è†½"; }
        } else {
            bankerHTML = `<div class="flex flex-col gap-1"><div class="flex items-center"><span class="text-lg font-bold text-yellow-400 w-6 text-center">${h1.number}</span> <span class="text-xs text-slate-400">${h1.name_ch || h1.name}</span></div><div class="flex items-center"><span class="text-lg font-bold text-yellow-400 w-6 text-center">${h2.number}</span> <span class="text-xs text-slate-400">${h2.name_ch || h2.name}</span></div></div>`;
            legsHTML = sortedHorses.slice(2, 5).map(h => `<span class="bg-slate-700 px-2 py-0.5 rounded mx-1 border border-slate-600 text-slate-300 font-mono">${h.number}</span>`).join("");
            const badge = document.querySelector('#betting-slip-card .rank-badge-label') || document.querySelector('#betting-slip-card .bg-red-600');
            if(badge) { badge.className = "rank-badge-label bg-yellow-600 text-black text-xs font-bold px-2 py-1 rounded"; badge.innerText = "é›™è†½"; }
        }
        document.getElementById('slip-banker').innerHTML = bankerHTML;
        document.getElementById('slip-legs').innerHTML = legsHTML;

        // Value Hunt (Strict Value Mode)
        const valuePicks = sortedHorses.filter(h => h.rank_prediction.includes('Value'));
        const wildcardContainer = document.getElementById('slip-wildcard');
        const reasonContainer = document.querySelector('#slip-wildcard-reason').parentElement;
        if(reasonContainer) reasonContainer.style.display = 'none';
        wildcardContainer.innerHTML = '';

        if (valuePicks.length > 0) {
            let listHTML = `<div class="flex flex-col gap-2 w-full">`;
            valuePicks.forEach(h => {
                let subText = "é«˜å€¼åšç‡";
                if (parseFloat(h.tir_bonus) >= 1.5) subText = `TIR ${h.tir_bonus} éš±è—å¯¦åŠ›`;
                listHTML += `<div class="flex items-center justify-between bg-slate-800/80 p-2 rounded border border-slate-700 hover:bg-slate-700/80 transition"><div class="flex items-center gap-3"><span class="text-xl font-bold text-blue-400 font-mono w-6 text-center">${h.number}</span><div class="flex flex-col leading-none gap-1"><span class="text-sm text-slate-200 font-medium">${h.name_ch || h.name}</span><span class="text-[10px] text-slate-500">${subText}</span></div></div><div><span class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold tracking-wider">VALUE</span></div></div>`;
            });
            listHTML += `</div>`;
            wildcardContainer.innerHTML = listHTML;
        } else {
            wildcardContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full py-2 opacity-50"><span class="text-slate-500 text-sm">æœ¬å ´ç„¡ Value è©•ç´šé¦¬</span></div>`;
        }
    }

    function fetchHistoryList() {
        const dateSelect = document.getElementById('date-select');
        dateSelect.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_race_list' }) })
            .then(res => res.json())
            .then(data => {
                if(data.list && data.list.length > 0) {
                    fullHistoryList = data.list; 
                    const uniqueDates = [...new Set(data.list.map(item => item.date))];
                    dateSelect.innerHTML = '';
                    uniqueDates.forEach(date => {
                        let opt = document.createElement('option');
                        opt.value = date;
                        opt.text = date;
                        dateSelect.add(opt);
                    });
                    if (uniqueDates.length > 0) {
                        dateSelect.value = uniqueDates[0]; 
                        onDateChange(); 
                    }
                } else {
                    dateSelect.innerHTML = '<option>ç„¡è³‡æ–™</option>';
                }
            })
            .catch(err => { console.error(err); dateSelect.innerHTML = '<option>é€£ç·šéŒ¯èª¤</option>'; });
    }

    function onDateChange() {
        const selectedDate = document.getElementById('date-select').value;
        const container = document.getElementById('race-buttons-container');
        container.innerHTML = '';
        const races = fullHistoryList.filter(item => item.date === selectedDate);
        races.sort((a, b) => Number(a.race_no) - Number(b.race_no));
        if (races.length === 0) { container.innerHTML = '<span class="text-slate-500">æ­¤æ—¥æœŸç„¡è³½äº‹æ•¸æ“š</span>'; return; }
        races.forEach(race => {
            const btn = document.createElement('button');
            btn.innerText = `R${race.race_no}`;
            btn.className = `race-btn px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 border border-slate-600 bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white`;
            btn.dataset.raceNo = race.race_no;
            btn.onclick = () => {
                document.querySelectorAll('.race-btn').forEach(b => {
                    b.className = `race-btn px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 border border-slate-600 bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white`;
                });
                btn.className = `race-btn px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 border border-emerald-500 bg-emerald-600 text-white shadow-lg shadow-emerald-900/50 transform scale-105 active`;
                loadHistory(selectedDate, race.race_no);
            };
            container.appendChild(btn);
        });
        if (container.firstChild) container.firstChild.click();
    }

    function loadHistory(date, raceNo) {
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_race_detail', date: date, race_no: raceNo }) })
        .then(res => res.json())
        .then(resp => {
            if(resp.result === 'success') {
                currentData = resp.data;
                renderDashboard(resp.data);
                // é€™è£¡ç§»é™¤äº†åŸæœ¬éš±è—/é¡¯ç¤º input-section çš„é‚è¼¯ï¼Œå› ç‚º viewer ç‰ˆæ ¹æœ¬æ²’æœ‰é‚£äº› section
            }
        })
        .catch(err => console.error("Load failed", err));
    }
</script>

</body>
</html>
